name: Tekton CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  trigger-tekton:
    runs-on: swqa-gh-runner-poc
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify kubectl access
      run: |
        echo "Verifying kubectl access to cluster..."
        kubectl version --client
        kubectl config current-context
        kubectl get nodes --no-headers | wc -l | xargs echo "Connected to cluster with nodes:"
        
    - name: Apply Tekton Pipeline definitions
      run: |
        echo "Applying Tekton Pipeline definitions from current codebase..."
        
        # Apply Task definition
        echo "üìã Applying Task..."
        kubectl apply -f .tekton/pipelines/task-pytest.yaml
        
        # Apply Pipeline definition  
        echo "üîÑ Applying Pipeline..."
        kubectl apply -f .tekton/pipelines/pipeline.yaml
        
        # Verify resources were created/updated
        echo "‚úÖ Verifying resources..."
        kubectl get task pytest-task -n default
        kubectl get pipeline pytest-pipeline -n default
        
    - name: Trigger Tekton Pipeline execution
      run: |
        # Use NodePort for external access (Runner cannot reach ClusterIP network)
        NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
        EVENTLISTENER_URL="http://$NODE_IP:30080"
        
        echo "üîç Using NodePort access: $EVENTLISTENER_URL"
        
        # Construct GitHub-style payload
        PAYLOAD=$(cat <<EOF
        {
          "repository": {
            "clone_url": "${{ github.server_url }}/${{ github.repository }}.git",
            "name": "${{ github.event.repository.name }}",
            "html_url": "${{ github.server_url }}/${{ github.repository }}"
          },
          "after": "${{ github.sha }}",
          "ref": "${{ github.ref }}",
          "head_commit": {
            "id": "${{ github.sha }}",
            "message": "${{ github.event.head_commit.message }}"
          }
        }
        EOF
        )
        
        # Send HTTP POST request to EventListener
        echo "üöÄ Triggering Tekton Pipeline execution..."
        echo "üì° Target URL: $EVENTLISTENER_URL"
        echo "üîç Commit SHA: ${{ github.sha }}"
        
        RESPONSE=$(curl -w "\nHTTP_CODE:%{http_code}" -X POST $EVENTLISTENER_URL \
          -H "Content-Type: application/json" \
          -H "X-GitHub-Event: push" \
          -d "$PAYLOAD")
        
        HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
        
        if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
          echo "‚úÖ Tekton Pipeline triggered successfully!"
          echo "üìä Dashboard: http://tekton.10.117.3.193.nip.io"
          echo "üîç PipelineRun: pytest-run-${{ github.sha }}"
          echo "‚è±Ô∏è  Check dashboard in ~30 seconds for execution status"
        else
          echo "‚ùå Failed to trigger Tekton Pipeline (HTTP $HTTP_CODE)"
          echo "Response: $RESPONSE"
          exit 1
        fi
