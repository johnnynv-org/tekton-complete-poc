# 07 - 端到端测试

本文档详细说明如何进行完整的端到端测试，验证从GitHub代码提交到Tekton执行的完整流程。

## 测试前准备

### 1. 环境确认清单

**Tekton环境：**
- [ ] Tekton Pipelines组件运行正常
- [ ] Tekton Triggers组件已安装
- [ ] Tekton Dashboard可访问：http://tekton.10.117.3.193.nip.io
- [ ] EventListener服务正常运行

**GitHub Runner：**
- [ ] 自宿主runner `swqa-gh-runner-poc` 在线
- [ ] Runner能访问Kubernetes集群内网
- [ ] curl命令可用

**Tekton资源：**
- [ ] EventListener已部署
- [ ] TriggerBinding和TriggerTemplate已配置
- [ ] Pipeline和Task已创建

### 2. 验证命令

```bash
# 检查Tekton组件
kubectl get pods -n tekton-pipelines

# 检查EventListener
kubectl get eventlistener -n default

# 检查Pipeline资源
kubectl get pipelines,tasks -n default

# 检查runner状态（在GitHub仓库Settings页面）
```

## 端到端测试流程

### 步骤1：代码修改和提交

**在本地环境中：**

```bash
# 进入项目目录
cd tekton-poc

# 创建一个简单的代码修改
echo "# Test comment for CI/CD demo $(date)" >> main.py

# 提交代码
git add .
git commit -m "test: trigger CI/CD pipeline - $(date +%Y%m%d-%H%M%S)"
git push origin main
```

### 步骤2：观察GitHub Actions

1. **打开GitHub仓库页面**：https://github.com/johnnynv/tekton-poc
2. **进入Actions标签页**
3. **观察workflow执行状态**：
   - 应该能看到新的workflow run开始
   - 运行在`swqa-gh-runner-poc`上
   - 显示"Tekton CI Pipeline"工作流

4. **点击进入具体的run**：
   - 查看"trigger-tekton" job的执行日志
   - 确认HTTP POST请求发送成功

### 步骤3：监控Tekton执行

**方式1：使用Tekton Dashboard**

1. 打开Dashboard：http://tekton.10.117.3.193.nip.io
2. 登录：用户名`admin`，密码`admin123`
3. 查看PipelineRuns页面：
   - 应该能看到新创建的PipelineRun
   - 名称格式：`pytest-run-<commit-sha>`
   - 状态从"Running"变为"Succeeded"

**方式2：使用kubectl命令**

```bash
# 查看最新的PipelineRun
kubectl get pipelinerun -n default --sort-by=.metadata.creationTimestamp

# 查看PipelineRun详细状态
kubectl describe pipelinerun <pipelinerun-name> -n default

# 实时查看TaskRun日志
kubectl get taskrun -n default -l tekton.dev/pipelineRun=<pipelinerun-name>
kubectl logs -f taskrun/<taskrun-name> -n default
```

### 步骤4：验证测试结果

**预期的执行步骤：**

1. **git-clone**: 克隆GitHub仓库代码
2. **install-dependencies**: 安装Python依赖包
3. **run-tests**: 执行所有pytest测试
4. **run-smoke-tests**: 执行标记为smoke的测试
5. **run-main-program**: 运行主程序演示

**成功标志：**
- 所有TaskRun状态为"Succeeded"
- pytest测试全部通过
- 在日志中看到测试执行输出

## 测试场景

### 场景1：正常代码提交

**操作：** 提交不影响测试的代码修改（如注释）
**预期：** Pipeline成功执行，所有测试通过

### 场景2：测试失败场景

**操作：** 故意修改代码造成测试失败
```python
# 在src/calculator.py中故意引入错误
def add(self, a, b):
    return a - b  # 故意写错
```

**预期：** Pipeline执行失败，能在Tekton Dashboard中看到失败原因

### 场景3：pytest标签测试

**验证：** 确认smoke测试和全量测试都能正常执行
- 查看TaskRun日志，确认两个测试步骤都有执行
- 验证`pytest -m smoke`和`pytest`命令都成功

## 性能指标

### 预期执行时间

- **GitHub Actions触发**: < 10秒
- **EventListener响应**: < 5秒
- **PipelineRun创建**: < 10秒
- **完整Pipeline执行**: 2-5分钟
  - git-clone: 10-30秒
  - install-dependencies: 30-60秒
  - run-tests: 10-30秒
  - run-smoke-tests: 5-15秒
  - run-main-program: 5-10秒

### 资源使用

- **存储**: 每个PipelineRun使用1Gi临时存储
- **CPU/内存**: 使用默认的resource requests
- **并发**: 支持多个PipelineRun并行执行

## 故障排除

### GitHub Actions问题

**症状：** Workflow未触发或执行失败

**排查步骤：**
1. 检查runner是否在线
2. 查看Actions页面的错误信息
3. 确认push是否到main分支

### HTTP请求问题

**症状：** GitHub Actions成功但Tekton未触发

**排查步骤：**
```bash
# 在runner机器上手动测试
curl -X POST http://el-github-listener.default.svc.cluster.local:8080 \
  -H "Content-Type: application/json" \
  -H "X-GitHub-Event: push" \
  -d '{"repository":{"clone_url":"https://github.com/johnnynv/tekton-poc.git"},"after":"main"}'
```

### EventListener问题

**症状：** HTTP请求发送但PipelineRun未创建

**排查步骤：**
```bash
# 检查EventListener状态
kubectl get eventlistener -n default
kubectl describe eventlistener github-listener -n default

# 查看EventListener日志
kubectl logs -l eventlistener=github-listener -n default

# 检查TriggerBinding和TriggerTemplate
kubectl get triggerbindings,triggertemplates -n default
```

### Pipeline执行问题

**症状：** PipelineRun创建但执行失败

**排查步骤：**
```bash
# 查看PipelineRun状态
kubectl describe pipelinerun <name> -n default

# 查看TaskRun日志
kubectl logs taskrun/<name> -n default --all-containers

# 检查工作空间和权限
kubectl get pvc -n default
```

## 成功验证清单

完整的端到端测试成功后，应该能确认：

- [ ] GitHub push触发了Actions workflow
- [ ] Runner成功发送HTTP请求
- [ ] EventListener接收并处理了请求
- [ ] TriggerTemplate创建了PipelineRun
- [ ] Pipeline成功执行了所有Task
- [ ] pytest测试全部通过
- [ ] 在Tekton Dashboard中能查看完整的执行历史
- [ ] 日志输出清晰，便于调试

## 下一步

端到端测试验证成功后，此POC项目已完成基本目标。可以考虑：

1. **扩展功能**：添加更多的测试场景
2. **优化性能**：改进Pipeline执行效率
3. **增强安全**：添加更多安全控制
4. **生产部署**：将此架构应用到实际项目中

更多详细信息请参考：
- [07 - 故障排除](./07-故障排除.md)
